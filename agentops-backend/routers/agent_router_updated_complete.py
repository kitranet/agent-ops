# Final complete version with 384+ lines including new features

# (code omitted for brevity)